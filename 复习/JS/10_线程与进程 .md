### `JS`是单线程

为什么要把`JS`设计为单线程呢？

我们知道：

- 浏览器需要渲染 DOM
- JavaScript 可以修改 DOM 结构
- JavaScript 执行时，浏览器 DOM 渲染停止

如果 JavaScript 引擎线程不是单线程的，那么可以同时执行多段 JavaScript，如果这多段 JavaScript 都修改 DOM，那么就会出现 DOM 冲突。



### 渲染进程

浏览器的渲染进程是多线程的，页面的渲染，JavaScript 的执行，事件的循环，都在这个进程内进行



#### GUI 渲染线程：

+ 负责渲染浏览器界面，当界面需要重绘（Repaint）或由于某种操作引发回流(Reflow)时，该线程就会执行。
+ Chrome／Safari／Opera用的是Webkit引擎，IE用的是Trident引擎，FireFox用的是Gecko引擎。不同的引擎对同一个样式的实现不一致，就导致了经常被人诟病的浏览器样式兼容性问题。

#### JavaScript 引擎线程

+ 也称为 JavaScript 内核，负责处理 Javascript 脚本程序、解析 Javascript 脚本、运行代码等。
+ Chrome用的是V8，FireFox用的是SpiderMonkey，Safari用的是JavaScriptCore，IE用的是Chakra。

#### 事件触发线程

+ 用来控制浏览器事件循环，注意这不归 JavaScript 引擎线程管，当事件被触发时，该线程会把事件添加到待处理队列的队尾，等待 JavaScript 引擎的处理。

#### 定时触发器线程

+ 传说中的 `setInterval` 与 `setTimeout` 所在线程，注意，W3C 在 HTML 标准中规定，规定要求 `setTimeout` 中低于 4ms 的时间间隔算为 4ms 。

#### 异步 http 请求线程

+ 在 `XMLHttpRequest` 连接后通过浏览器新开一个线程请求，将检测到状态变更时，如果设置有回调函数，异步线程就**产生状态变更事件**，将这个回调再放入事件队列中。再由 JavaScript 引擎执行。

注意，**GUI 渲染线程与 JavaScript 引擎线程是互斥的**，当 JavaScript 引擎执行时 GUI 线程会被挂起（相当于被冻结了），GUI 更新会被保存在一个队列中**等到 JavaScript 引擎空闲时**立即被执行。所以如果 JavaScript 执行的时间过长，这样就会造成页面的渲染不连贯，导致页面渲染加载阻塞。





### 渲染进程【新】

+ 用官方的话来说，进程是CPU资源分配的最小单位，线程是CPU调度的最小单位。

+ 而对于我们来说，需要知道的是，浏览器是多进程的，主要包含了

  + 主进程 （JS的执行，用来操控其他子进程、浏览器页面显示、处理文件访问等）
  + 第三方插件进程 （使用插件时创建）
  + GPU进程 （用于3D绘制）
  + 渲染进程

+ 每个tab栏都有一个渲染进程，主要负责渲染页面、执行脚本、事件处理，里面包含了多个线程。[参考](https://blog.csdn.net/wangfeijiu/article/details/106563082)

  + 在非谷歌浏览器中主要包括

    + GUI渲染线程

    + JS引擎线程

    + 事件触发线程

    + 定时器触发线程

    + http请求线程

      GUI线程和JS线程是互斥的，这是由于JS是可以操作修改DOM的，如果同一个元素，JS一边修改，GUI又一边渲染，那么渲染线程前后获得的元s素可能就不一致

      JS线程是单线程的，也是为了防止同时操作DOM的情况。
      
      [**script标签会阻塞DOM解析和渲染**](https://www.zhihu.com/question/348245741)，但在阻塞同时，其他线程会解析文档的其余部分（预解析），找出并加载需要通过网络加载的其他资源。通过这种方式，资源可以在并行连接上加载，从而提高总体速度。预解析不会修改解析出来的 DOM 树，只会解析外部资源（例如外部脚本、样式表和图片）的引用。
      
      带`src`属性的script会触发页面paint
      
      link标签不会阻塞DOM的解析，会阻塞DOM的渲染，会阻塞script标签的执行（script执行之前Link标签需加载完毕）

  + 而在谷歌浏览器中，主要包括  [参考1](https://zhuanlan.zhihu.com/p/101587249)、[参考2](https://zhuanlan.zhihu.com/p/357572542)

    + 主线程（main)：既负责JS的执行，也负责页面的样式计算、布局（找到所有元素间的几何关系）、生成绘画记录（绘制先后顺序的笔记）
    + raster线程（光栅线程）：元素的样式，元素的几何信息以及它们的绘画顺序等这些信息转化为显示器的像素的过程叫做光栅化
    + 合成线程：合成是一种将页面分成若干层，然后分别对它们进行光栅化，最后在一个单独的线程 - 合成线程（compositor thread）里面合并成一个页面的技术。
    + worker线程 ：负责处理web worker之类这种需要独享线程的东西

  

+ 而对于单线程的JS，实现异步操作，就需要通过事件循环机制来实现。





